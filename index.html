<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=400, initial-scale=1.0">
  <title>XYZ MENU</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --menu-color: 138, 43, 226;
      --accent-color: 255, 165, 0;
      --menu-x: 0px;
      --menu-y: 0px;
      --menu-alpha: 1;
      --banner-hue: 0deg;
      --banner-brightness: 0.93;
      --banner-contrast: 1.10;
      --banner-saturate: 1.07;
      --menu-item-height: 36px;
      --menu-visible-items: 9;
      --menu-list-padding: 6px;
      --banner-height: 54px;
      --categorybar-height: 28px;
      --footer-height: 28px;
      --menu-width: 280px;
    }
    html, body {
      background: none !important;
      background-color: transparent !important;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      margin: 0;
      padding: 0;
      pointer-events: none;
      user-select: none;
    }
    html::before, html::after, body::before, body::after {
      background: none !important;
      background-color: transparent !important;
    }
    .menu-wrapper {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(var(--menu-x), var(--menu-y));
      user-select: none;
      pointer-events: none;
    }
    .menu-container {
      width: var(--menu-width);
      background: none !important;
      background-color: transparent !important;
      border-radius: 4px;
      overflow: hidden;
      backdrop-filter: none !important;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: none !important;
      display: flex;
      flex-direction: column;
      position: relative;
      justify-content: flex-start;
      pointer-events: none;
    }
    .current-category {
      background: rgba(18, 18, 18, 0.92) !important;
      color: rgba(255, 255, 255, 0.7);
      padding: 6px 10px;
      font-size: 11px;
      font-weight: 500;
      text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 4px 4px 0 0;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      position: relative;
      min-height: var(--categorybar-height);
      line-height: 1.15;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
      z-index: 1;
      pointer-events: none;
    }
    .header-icon {
      display: none;
    }
    .menu-items {
      flex: 1 1 auto;
      min-height: 0;
      overflow: hidden;
      position: relative;
      padding: var(--menu-list-padding) 0 10px 0;
      background: rgba(18, 18, 18, 0.92);
      pointer-events: none;
    }
    .menu-item {
      height: var(--menu-item-height);
      padding: 0 10px;
      margin: 0 0 1px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      font-weight: 400;
      color: rgba(255, 255, 255, 0.9);
      background: transparent;
      border: none;
      border-bottom: 1px solid rgba(255, 255, 255, 0.03);
      transition: background 0.1s ease;
      position: absolute;
      width: calc(100% - 0px);
      left: 0px;
      pointer-events: none;
      opacity: 1;
    }
    .menu-item:hover {
      background: rgba(255, 255, 255, 0.02);
    }
    .menu-item.selected {
      background: rgba(var(--menu-color), 0.15);
      opacity: 1;
      z-index: 2;
    }
    .menu-item.selected > span:first-child {
      color: rgb(var(--menu-color));
      font-weight: 600;
    }
    .menu-item > span:first-child {
      color: #fff;
      font-weight: 400;
      letter-spacing: 0.2px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .arrow {
      color: rgba(255, 255, 255, 0.4);
      font-weight: 700;
      font-size: 14px;
      margin-left: 4px;
    }
    .checkbox-bar {
      width: 38px; 
      height: 20px;
      background: rgba(100, 100, 100, 0.4);
      border-radius: 10px;
      border: none;
      position: relative;
      display: flex;
      align-items: center;
      transition: all 0.2s ease;
      box-sizing: border-box;
      pointer-events: none;
    }
    .checkbox-bar.checked {
      background: rgba(var(--menu-color), 0.6);
    }
    .checkbox-knob {
      width: 16px; 
      height: 16px; 
      border-radius: 50%;
      background: #fff;
      border: none;
      position: absolute; 
      left: 2px; 
      top: 2px;
      transition: left 0.2s ease;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      pointer-events: none;
    }
    .checkbox-bar.checked .checkbox-knob {
      left: 20px;
      background: #fff;
    }
    .slider-bar {
      width: 70px; 
      height: 4px;
      background: rgba(100, 100, 100, 0.4);
      border-radius: 2px;
      border: none;
      position: relative;
      display: flex;
      align-items: center;
      margin-right: 1px;
      pointer-events: none;
    }
    .slider-knob {
      width: 12px; 
      height: 12px; 
      border-radius: 50%;
      background: rgb(var(--menu-color));
      border: none;
      position: absolute; 
      top: -4px; 
      left: 0;
      transition: left 0.15s ease;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      z-index: 2;
      pointer-events: none;
    }
    .slider-bar .slider-fill {
      position: absolute; 
      left: 0; 
      top: 0; 
      height: 100%;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 2px;
      z-index: 1; 
      pointer-events: none;
      transition: width 0.15s ease;
    }
    .color-preview {
      width: 12px; 
      height: 12px;
      background: rgba(var(--menu-color), var(--menu-alpha, 1));
      border-radius: 2px;
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.2);
      margin-right: 2px;
      pointer-events: none;
    }
    .car-name-dynamic {
      display: inline-block;
      min-width: 60px;
      text-align: center;
      font-family: monospace;
      padding: 2px 6px;
      color: rgba(255, 255, 255, 0.8);
      user-select: none;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 2px;
      font-size: 10px;
      pointer-events: none;
    }
    .custom-scrollbar {
      display: none !important;
    }
    .banner {
      position: relative;
      overflow: hidden;
      height: var(--banner-height);
      min-height: var(--banner-height);
      background: none !important;
      box-shadow: none;
      margin: 0;
      border-bottom: none;
      pointer-events: none;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
    }
    .banner img {
      width: 100%;
      height: var(--banner-height);
      display: block;
      object-fit: cover;
      filter: brightness(var(--banner-brightness)) contrast(var(--banner-contrast)) saturate(var(--banner-saturate)) hue-rotate(var(--banner-hue));
      transition: filter 0.5s;
      margin: 0;
      padding: 0;
      pointer-events: none;
    }
    .banner::after {
      display: none;
    }
    .spectator-overlay {
      position: fixed;
      background: rgba(18, 18, 18, 0.92);
      border-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: none;
      z-index: 200;
      display: none;
      flex-direction: column;
      align-items: stretch;
      padding: 8px 12px;
      min-width: 110px;
      max-width: 180px;
      pointer-events: none;
      overflow: visible;
    }
    .spectator-overlay-title {
      color: rgba(255, 255, 255, 0.7);
      font-weight: 500;
      font-size: 11px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      margin-bottom: 6px;
      text-align: center;
      padding-bottom: 4px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }
    .spectator-overlay-divider {
      display: none;
    }
    .spectator-overlay-list {
      display: flex;
      flex-direction: column;
      gap: 2px;
      align-items: flex-start;
      min-height: 7px;
      max-height: 85px;
      background: transparent;
      border-radius: 0;
      padding: 4px 0;
      width: 100%;
    }
    .spectator-overlay-user {
      font-weight: 400;
      color: rgba(255, 255, 255, 0.9);
      letter-spacing: 0.2px;
      min-width: 0;
      max-width: 125px;
      text-align: left;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      pointer-events: none;
      font-size: 11px;
      padding: 1px 2px;
      margin: 0;
      background: none !important;
      border: none !important;
      box-shadow: none !important;
      border-radius: 0 !important;
    }
    .color-picker-modal {
      position: fixed;
      left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      background: rgba(18, 18, 18, 0.92);
      border-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      z-index: 999;
      padding: 20px;
      display: none;
      flex-direction: column;
      gap: 12px;
      align-items: center;
      min-width: 160px;
      box-shadow: none;
      pointer-events: none;
    }
    .color-picker-canvas {
      border-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      width: 120px;
      height: 60px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      background: #111;
      position: relative;
      pointer-events: none;
    }
    .color-picker-cursor {
      position: absolute;
      width: 12px;
      height: 12px;
      border: 2px solid #fff;
      border-radius: 50%;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.8), 0 0 10px rgba(255,255,255,0.5);
      pointer-events: none;
      transform: translate(-50%, -50%);
      z-index: 10;
      display: block;
      background: rgba(255,255,255,0.2);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    .color-picker-preview {
      margin: 0 auto;
      width: 30px; height: 30px;
      border-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      background: rgba(var(--menu-color), var(--menu-alpha, 1));
    }
    .color-picker-label {
      color: rgba(255, 255, 255, 0.7);
      font-size: 11px;
      font-weight: 500;
      display: block;
      text-align: center;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }
    .color-picker-values {
      color: rgba(255, 255, 255, 0.6);
      font-family: monospace;
      font-size: 10px;
      text-align: center;
    }
    .color-picker-instructions {
      color: rgba(255, 255, 255, 0.5);
      font-size: 9px;
      text-align: center;
      line-height: 1.4;
    }
    .position-picker-modal {
      position: fixed;
      left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      background: rgba(18, 18, 18, 0.92);
      border-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      z-index: 998;
      padding: 20px;
      display: none;
      flex-direction: column;
      gap: 16px;
      align-items: center;
      min-width: 240px;
      box-shadow: none;
      pointer-events: none;
    }
    .position-picker-label {
      color: rgba(255, 255, 255, 0.7);
      font-size: 11px;
      font-weight: 500;
      text-align: center;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }
    .position-picker-instructions {
      color: rgba(255, 255, 255, 0.6);
      font-size: 10px;
      text-align: center;
      line-height: 1.6;
      max-width: 200px;
    }
    .footer {
      background: rgba(18, 18, 18, 0.92) !important;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 10px;
      font-size: 10px;
      color: rgba(255, 255, 255, 0.5);
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 0 0 4px 4px;
      font-weight: 400;
      letter-spacing: 0.3px;
      height: var(--footer-height);
      min-height: var(--footer-height);
      line-height: 1.15;
      position: relative;
      margin-top: auto;
      pointer-events: none;
    }
    .footer > div { display: flex; align-items: center; gap: 8px; }
    .version::before {
      content: '●';
      color: rgb(var(--menu-color));
      animation: pulse-dot 2s infinite;
      font-size: 8px;
      margin-right: 4px;
    }
    @keyframes pulse-dot {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(1.1); }
    }
    .page {
      background: rgba(255, 255, 255, 0.05);
      padding: 2px 6px;
      border-radius: 2px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      font-family: 'Inter', sans-serif;
      font-weight: 400;
      font-size: 9px;
    }
  </style>
</head>
<body>
<div class="menu-wrapper" id="menuWrapper">
  <div class="menu-container" id="menuContainer">
    <div class="current-category" id="currentCategory">
      <span id="categoryName">Main Menu</span>
    </div>
    <div class="menu-items" id="menuList"></div>
    <div class="banner">
      <img src="https://negrnegr.github.io/xyzmenu/banner/bannernew.gif" alt="XYZ Menu Banner" id="bannerImage">
    </div>
    <div class="footer">
      <div class="version">Version Beta</div>
      <div class="page" id="selectedIndex">1/7</div>
    </div>
  </div>
  <div class="custom-scrollbar" id="customScrollbar">
    <div class="scrollbar-before"></div>
    <div class="scrollbar-thumb"></div>
  </div>
</div>

<div class="spectator-overlay" id="spectatorOverlay">
  <div class="spectator-overlay-title">Spectator List</div>
  <div class="spectator-overlay-divider"></div>
  <div class="spectator-overlay-list" id="spectatorListOverlay"></div>
</div>

<div class="color-picker-modal" id="colorPickerModal">
  <span class="color-picker-label">Pick menu color</span>
  <div style="position: relative;">
    <canvas class="color-picker-canvas" id="colorCanvas" width="120" height="60"></canvas>
    <div class="color-picker-cursor" id="colorPickerCursor"></div>
  </div>
  <div class="color-picker-preview" id="colorPickerPreview"></div>
  <div class="color-picker-values" id="colorPickerValues">rgba(138,43,226,1)</div>
  <div class="color-picker-instructions">
    Hold arrows to move cursor<br>
    Enter = confirm • Backspace = cancel
  </div>
</div>

<div class="position-picker-modal" id="positionPickerModal">
  <span class="position-picker-label" id="positionPickerLabel">Hold arrow keys to move the menu</span>
  <div class="position-picker-instructions">
    Press Enter to confirm or Backspace to cancel.
  </div>
</div>

<script>
const carNames = [
  "BMW X5", "Audi RS6", "Tesla Cybertruck", "Porsche 911", "Lamborghini Aventador",
  "Ferrari Roma", "McLaren 765LT", "Toyota Supra", "Nissan GT-R", "Ford Mustang",
  "Chevrolet Camaro", "Dodge Challenger", "Mercedes G63", "Honda NSX", "Mazda RX-7",
  "Subaru Impreza", "Bugatti Chiron", "Aston Martin DB11", "Lexus LC500", "Volkswagen Golf R"
];
let selectedCarIndex = 0;

function randomPlayers() {
  const samples = [
    "Migi", "NoobMaster", "ShadowWolf", "xXx_Slayer_xXx", "Zoomer", "Marek", "Skillz", "CyberBeast", "MegaPro", "Dominator",
    "FireFox", "Archer", "KillerJoe", "PlayerZero", "Xenon", "Phantom", "Viper", "Ghost", "Sniper", "Lightning"
  ];
  let shuffled = [...samples].sort(() => Math.random() - 0.5);
  return shuffled.slice(0, 10).map(n => ({ name: n, type: 'checkbox', checked: false }));
}

const menuStructure = {
  main: [
    { name: 'Self', type: 'submenu' },
    { name: 'Vehicle', type: 'submenu' },
    { name: 'Vehicle Tune', type: 'submenu' },
    { name: 'Players', type: 'submenu' },
    { name: 'Exploits', type: 'submenu' },
    { name: 'Triggers', type: 'submenu' },
    { name: 'Settings', type: 'submenu' }
  ],
  self: [
    { name: 'GodMode', type: 'checkbox', checked: false },
    { name: 'NoClip', type: 'checkbox', checked: false },
    { name: 'Infinite Health', type: 'checkbox', checked: false },
    { name: 'Super Speed', type: 'checkbox', checked: false },
    { name: 'Teleport', type: 'action' },
    { name: 'Invisible', type: 'checkbox', checked: false },
    { name: 'Fast Run', type: 'checkbox', checked: false }
  ],
  vehicle: [
    { name: 'Spawn Vehicle', type: 'submenu' },
    { name: 'Delete Car', type: 'action' },
    { name: 'Drift Mode', type: 'checkbox', checked: false },
    { name: 'Horn Boost', type: 'checkbox', checked: false },
    { name: 'Instant Break', type: 'checkbox', checked: false },
    { name: 'Car Jump', type: 'action' },
    { name: 'Vehicle Backflip', type: 'action' },
    { name: 'Repair Vehicle', type: 'action' },
    { name: 'Infinite Fuel', type: 'checkbox', checked: false }
  ],
  spawnvehicle: [
    { name: 'Addon Vehicles', type: 'carselector' },
    { name: 'Sports Cars', type: 'submenu' },
    { name: 'Super Cars', type: 'submenu' },
    { name: 'Motorcycles', type: 'submenu' },
    { name: 'Trucks', type: 'submenu' },
    { name: 'Aircraft', type: 'submenu' }
  ],
  sportscars: [
    { name: 'Spawn Comet', type: 'action' },
    { name: 'Spawn Banshee', type: 'action' },
    { name: 'Spawn Carbonizzare', type: 'action' },
    { name: 'Spawn Elegy', type: 'action' }
  ],
  supercars: [
    { name: 'Spawn Adder', type: 'action' },
    { name: 'Spawn Entity', type: 'action' },
    { name: 'Spawn Zentorno', type: 'action' },
    { name: 'Spawn T20', type: 'action' }
  ],
  motorcycles: [
    { name: 'Spawn Akuma', type: 'action' },
    { name: 'Spawn Bati', type: 'action' },
    { name: 'Spawn Double T', type: 'action' },
    { name: 'Spawn PCJ', type: 'action' }
  ],
  trucks: [
    { name: 'Spawn Phantom', type: 'action' },
    { name: 'Spawn Packer', type: 'action' },
    { name: 'Spawn Hauler', type: 'action' },
    { name: 'Spawn Benson', type: 'action' }
  ],
  aircraft: [
    { name: 'Spawn Buzzard', type: 'action' },
    { name: 'Spawn Maverick', type: 'action' },
    { name: 'Spawn Luxor', type: 'action' },
    { name: 'Spawn Shamal', type: 'action' }
  ],
  vehicletune: [
    { name: 'Max Tuning', type: 'action' },
    { name: 'Primary Color', type: 'color' },
    { name: 'Secondary Color', type: 'color' },
    { name: 'Pearlescent Color', type: 'color' },
    { name: 'Apply Colors', type: 'action' },
    { name: 'Turbo', type: 'checkbox', checked: false },
    { name: 'Xenon Headlights', type: 'checkbox', checked: false },
    { name: 'Visual Tuning', type: 'submenu' }
  ],
  visualtuning: [
    { name: 'Spoiler', type: 'slider', value: 0, min: 0, max: 10 },
    { name: 'Front Bumper', type: 'slider', value: 0, min: 0, max: 10 },
    { name: 'Rear Bumper', type: 'slider', value: 0, min: 0, max: 10 },
    { name: 'Side Skirt', type: 'slider', value: 0, min: 0, max: 10 },
    { name: 'Exhaust', type: 'slider', value: 0, min: 0, max: 10 },
    { name: 'Frame', type: 'slider', value: 0, min: 0, max: 10 },
    { name: 'Grille', type: 'slider', value: 0, min: 0, max: 10 },
    { name: 'Hood', type: 'slider', value: 0, min: 0, max: 10 },
    { name: 'Fender', type: 'slider', value: 0, min: 0, max: 10 },
    { name: 'Right Fender', type: 'slider', value: 0, min: 0, max: 10 },
    { name: 'Roof', type: 'slider', value: 0, min: 0, max: 10 },
    { name: 'Wheels', type: 'slider', value: 0, min: 0, max: 10 },
    { name: 'Window Tint', type: 'slider', value: 0, min: 0, max: 5 },
    { name: 'Livery', type: 'slider', value: 0, min: 0, max: 10 }
  ],
  players: [
    { name: 'Player List', type: 'submenu' },
    { name: 'Spectate Player', type: 'action' },
    { name: 'Teleport to Player', type: 'action' },
    { name: 'Bring Player', type: 'action' },
    { name: 'Kill Player', type: 'action' },
    { name: 'Explode Player', type: 'action' },
    { name: 'Kick Player', type: 'action' }
  ],
  playerlist: randomPlayers(),
  exploits: [
    { name: 'Money Drop', type: 'action' },
    { name: 'RP Drop', type: 'action' },
    { name: 'Crash Player', type: 'action' },
    { name: 'Freeze Player', type: 'action' },
    { name: 'Set Player On Fire', type: 'action' },
    { name: 'Clone Player', type: 'action' },
    { name: 'Cage Player', type: 'action' }
  ],
  triggers: [
    { name: 'Enable Trigger 1', type: 'checkbox', checked: false },
    { name: 'Enable Trigger 2', type: 'checkbox', checked: false },
    { name: 'Configure Triggers', type: 'action' },
    { name: 'Reset Triggers', type: 'action' },
    { name: 'Print Coords', type: 'action' },
    { name: 'Save Position', type: 'action' },
    { name: 'Load Position', type: 'action' }
  ],
  settings: [
    { name: 'Menu Position', type: 'action' },
    { name: 'Menu Color', type: 'color' },
    { name: 'Spectator List', type: 'checkbox', checked: false },
    { name: 'Spectator Position', type: 'action' }
  ]
};

let currentMenu = 'main';
let currentIndex = 0;
let viewportStart = 0;
let menuPositions = {};
const VISIBLE_ITEMS = 9;
const ITEM_HEIGHT = 36;
const categoryBarHeight = 28;
const bannerHeight = 54;
const footerHeight = 28;
const menuWidth = 280;

const spectatorOverlay = document.getElementById('spectatorOverlay');
const spectatorListOverlay = document.getElementById('spectatorListOverlay');
const categoryDisplay = document.getElementById('categoryName');
const indexDisplay = document.getElementById('selectedIndex');
const colorPickerModal = document.getElementById('colorPickerModal');
const colorCanvas = document.getElementById('colorCanvas');
const colorPickerPreview = document.getElementById('colorPickerPreview');
const colorPickerValues = document.getElementById('colorPickerValues');
const colorPickerCursor = document.getElementById('colorPickerCursor');
const positionPickerModal = document.getElementById('positionPickerModal');
const positionPickerLabel = document.getElementById('positionPickerLabel');
const menuWrapper = document.getElementById('menuWrapper');
const menuContainer = document.getElementById('menuContainer');

let menuOffsetX = 0, menuOffsetY = 0;
let colorCursorX = 60, colorCursorY = 30;
let tempMenuColor = { r: 138, g: 43, b: 226, a: 1 };
let positionPickerMode = null;
let currentMenuPosX = 50, currentMenuPosY = 50;
let currentSpectatorPosX = 70, currentSpectatorPosY = 15;
let tempMenuPosX = 50, tempMenuPosY = 50;
let tempSpectatorPosX = 70, tempSpectatorPosY = 15;
let menuColor = { r: 138, g: 43, b: 226, a: 1 };
let currentState = 'menu';

let isClosingViaBackspace = false;

const SPECTATORS = [
  'Spectator_One', 'Spectator_Two', 'Spectator_Three', 'Spectator_Four', 'Spectator_Five'
];

window.addEventListener("message", function(event) {
    let data;
    try {
        data = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
    } catch (e) {
        return;
    }
    
    if (data.action === "navigate") {
        if (currentState === 'menu') {
            if (data.direction === "up") navigateUp();
            if (data.direction === "down") navigateDown();
            if (data.direction === "left") navigateLeft();
            if (data.direction === "right") navigateRight();
        } else if (currentState === 'colorpicker') {
            moveColorCursor(data.direction);
        } else if (currentState === 'positionpicker') {
            movePosition(data.direction);
        }
    }
    
    if (data.action === "select") {
        if (currentState === 'menu') {
            selectItem();
        } else if (currentState === 'colorpicker') {
            confirmColorPicker();
        } else if (currentState === 'positionpicker') {
            confirmPositionPicker();
        }
    }
    
    if (data.action === "back") {
        if (currentState === 'colorpicker') {
            closeColorPicker();
        } else if (currentState === 'positionpicker') {
            closePositionPicker();
        } else if (currentState === 'menu') {
            goBack();
        }
    }
    
    if (data.action === "close") {
        currentState = 'menu';
        closeColorPicker();
        closePositionPicker();
        isClosingViaBackspace = false;
    }
    
    if (data.action === "updateColor") {
        if (data.r && data.g && data.b) {
            document.documentElement.style.setProperty('--menu-color', `${data.r}, ${data.g}, ${data.b}`);
            if (data.a) document.documentElement.style.setProperty('--menu-alpha', data.a);
        }
    }
    
    if (data.action === "updateBanner" && data.url) {
        document.getElementById('bannerImage').src = data.url;
    }
});

window.currentMenu = currentMenu;

function getDynamicCarFont(car) {
  if (car.length >= 20) return "9px";
  if (car.length >= 15) return "10px";
  if (car.length >= 11) return "10px";
  return "10px";
}

function getDynamicSpectatorFont(name) {
  if (name.length >= 19) return "9px";
  if (name.length >= 15) return "10px";
  if (name.length >= 11) return "10.5px";
  return "11px";
}

function createMenuItem(item, index) {
  const div = document.createElement('div');
  div.className = 'menu-item';
  let rightElement = '';
  
  switch (item.type) {
    case 'submenu':
      rightElement = '<span class="arrow">»</span>';
      break;
    case 'checkbox':
      rightElement = `<div class="checkbox-bar${item.checked ? " checked" : ""}"><div class="checkbox-knob"></div></div>`;
      break;
    case 'slider':
      const percent = (item.value - item.min) / (item.max - item.min);
      const knobLeft = percent * (70 - 12);
      rightElement = `<div class="slider-bar"><div class="slider-fill" style="width:${percent*100}%"></div><div class="slider-knob" style="left:${knobLeft}px"></div></div>`;
      break;
    case 'color':
      rightElement = `<div class="color-preview"></div>`;
      break;
    case 'action':
      rightElement = '';
      break;
    case 'carselector': {
      const car = carNames[selectedCarIndex];
      rightElement = `
        <span class="car-name-dynamic" style="font-size:${getDynamicCarFont(car)};">
          - ${car} -
        </span>
      `;
      break;
    }
  }
  
  div.innerHTML = `<span>${item.name}</span>${rightElement}`;
  return div;
}

function renderMenu() {
  const menuList = document.getElementById('menuList');
  menuList.innerHTML = '';
  const items = menuStructure[currentMenu];
  const visibleCount = Math.min(items.length, VISIBLE_ITEMS);
  const menuItemsHeight = visibleCount * ITEM_HEIGHT + 10;
  const dynamicHeight = categoryBarHeight + menuItemsHeight + bannerHeight + footerHeight;
  menuContainer.style.height = dynamicHeight + "px";
  
  items.forEach((item, idx) => {
    const menuItem = createMenuItem(item, idx);
    menuItem.classList.toggle('selected', idx === currentIndex);
    menuItem.style.position = 'absolute';
    menuItem.style.top = `${(idx-viewportStart)*ITEM_HEIGHT}px`;
    menuItem.style.left = '0px';
    menuItem.style.width = 'calc(100% - 0px)';
    menuItem.style.display = idx-viewportStart >= 0 && idx-viewportStart < visibleCount ? 'flex' : 'none';
    menuList.appendChild(menuItem);
  });
  
  indexDisplay.textContent = `${currentIndex + 1}/${items.length}`;
  categoryDisplay.textContent = currentMenu === 'main' ? 'Main Menu' : capitalizeFirst(currentMenu);
  updateSpectatorOverlay();
  
  window.currentMenu = currentMenu;
}

function capitalizeFirst(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}

function scrollToKeepVisible() {
  const items = menuStructure[currentMenu];
  const visibleCount = Math.min(items.length, VISIBLE_ITEMS);
  if (currentIndex < viewportStart) {
    viewportStart = currentIndex;
  } else if (currentIndex >= viewportStart + visibleCount) {
    viewportStart = currentIndex - visibleCount + 1;
  }
  viewportStart = Math.max(0, Math.min(viewportStart, items.length - visibleCount));
  if (items.length <= visibleCount) viewportStart = 0;
}

function navigateUp() {
  const items = menuStructure[currentMenu];
  currentIndex = currentIndex > 0 ? currentIndex - 1 : items.length - 1;
  scrollToKeepVisible();
  renderMenu();
}

function navigateDown() {
  const items = menuStructure[currentMenu];
  currentIndex = currentIndex < items.length - 1 ? currentIndex + 1 : 0;
  scrollToKeepVisible();
  renderMenu();
}

function navigateLeft() {
  const items = menuStructure[currentMenu];
  const item = items[currentIndex];
  if (item && item.type === 'slider') {
    item.value = Math.max(item.min, item.value - 1);
    renderMenu();
  } else if (item && item.type === 'carselector') {
    selectedCarIndex = (selectedCarIndex - 1 + carNames.length) % carNames.length;
    renderMenu();
  }
}

function navigateRight() {
  const items = menuStructure[currentMenu];
  const item = items[currentIndex];
  if (item && item.type === 'slider') {
    item.value = Math.min(item.max, item.value + 1);
    renderMenu();
  } else if (item && item.type === 'carselector') {
    selectedCarIndex = (selectedCarIndex + 1) % carNames.length;
    renderMenu();
  }
}

function selectItem() {
  const items = menuStructure[currentMenu];
  const item = items[currentIndex];
  if (!item) return;
  
  switch(item.type) {
    case 'submenu': {
      const submenuKey = item.name.toLowerCase().replace(/ /g, '');
      if (submenuKey === "playerlist") {
        menuStructure.playerlist = randomPlayers();
      }
      if (menuStructure[submenuKey]) {
        menuPositions[currentMenu] = currentIndex;
        currentMenu = submenuKey;
        currentIndex = menuPositions[submenuKey] || 0;
        viewportStart = 0;
        renderMenu();
      }
      break;
    }
    case 'checkbox':
      item.checked = !item.checked;
      renderMenu();
      break;
    case 'carselector':
      console.log(`Spawned car: ${carNames[selectedCarIndex]}`);
      break;
    case 'color':
      openColorPicker();
      break;
    case 'action':
      if (item.name === 'Menu Position') {
        openPositionPicker('menu');
      } else if (item.name === 'Spectator Position') {
        openPositionPicker('spectator');
      } else {
        console.log(`Action: ${item.name}`);
      }
      break;
  }
}

function goBack() {
  if (currentMenu !== 'main') {
    menuPositions[currentMenu] = currentIndex;
    
    let parentMenu = 'main';
    if (currentMenu === 'spawnvehicle' || currentMenu === 'sportscars' || currentMenu === 'supercars' || 
        currentMenu === 'motorcycles' || currentMenu === 'trucks' || currentMenu === 'aircraft') {
      parentMenu = currentMenu === 'spawnvehicle' ? 'vehicle' : 'spawnvehicle';
    } else if (currentMenu === 'visualtuning') {
      parentMenu = 'vehicletune';
    } else if (currentMenu === 'playerlist') {
      parentMenu = 'players';
    } else {
      parentMenu = 'main';
    }
    
    currentMenu = parentMenu;
    currentIndex = menuPositions[parentMenu] || 0;
    viewportStart = 0;
    renderMenu();
  } else {
    if (!isClosingViaBackspace) {
      isClosingViaBackspace = true;
      
      window.closeMenuFromBackspace = true;
      
      window.shouldCloseLua = true;
      window.isClosingMenu = true;
      
      setTimeout(() => {
        isClosingViaBackspace = false;
        window.closeMenuFromBackspace = false;
        window.shouldCloseLua = false;
        window.isClosingMenu = false;
      }, 300);
    }
  }
}

function openColorPicker() {
  currentState = 'colorpicker';
  colorPickerModal.style.display = 'flex';
  drawColorPicker();
  colorCursorX = 60;
  colorCursorY = 30;
  updateColorPickerCursor();
  updateColorFromCursor();
  
  window.luaMenuState = 'colorpicker';
}

function closeColorPicker() {
  currentState = 'menu';
  colorPickerModal.style.display = 'none';
  
  window.luaMenuState = 'menu';
}

function confirmColorPicker() {
  menuColor = { ...tempMenuColor };
  applyMenuColors();
  closeColorPicker();
  renderMenu();
}

function applyMenuColors() {
  const r = menuColor.r;
  const g = menuColor.g;  
  const b = menuColor.b;
  const a = menuColor.a;
  
  const brightness = calculateBrightness(r, g, b);
  const saturation = calculateSaturation(r, g, b);
  
  let filterBrightness = 0.93;
  let filterContrast = 1.10;
  let filterSaturate = 1.07;
  let hueRotate = 0;
  
  if (brightness > 200) {
    filterBrightness = 0.4 + (brightness / 255) * 0.3;
    filterContrast = 1.5;
    filterSaturate = 0.3 + (saturation / 255) * 0.5;
  } else if (brightness > 150) {
    filterBrightness = 0.6 + (brightness / 255) * 0.2;
    filterContrast = 1.3;
    filterSaturate = 0.5 + (saturation / 255) * 0.7;
  } else {
    filterBrightness = 0.85 + (brightness / 255) * 0.15;
    filterContrast = 1.3;
    filterSaturate = 1.5 + (saturation / 255) * 0.5;
    hueRotate = getHueFromRGB(r, g, b);
  }
  
  document.documentElement.style.setProperty('--menu-color', `${r}, ${g}, ${b}`);
  document.documentElement.style.setProperty('--menu-alpha', a);
  document.documentElement.style.setProperty('--banner-hue', `${hueRotate}deg`);
  document.documentElement.style.setProperty('--banner-brightness', filterBrightness);
  document.documentElement.style.setProperty('--banner-contrast', filterContrast);
  document.documentElement.style.setProperty('--banner-saturate', filterSaturate);
}

function calculateBrightness(r, g, b) {
  return (r * 299 + g * 587 + b * 114) / 1000;
}

function calculateSaturation(r, g, b) {
  const max = Math.max(r, g, b);
  const min = Math.min(r, g, b);
  return max - min;
}

function updateColorPickerCursor() {
  colorPickerCursor.style.left = colorCursorX + 'px';
  colorPickerCursor.style.top = colorCursorY + 'px';
}

function updateColorFromCursor() {
  const ctx = colorCanvas.getContext('2d');
  const imgData = ctx.getImageData(colorCursorX, colorCursorY, 1, 1);
  const rgba = imgData.data;
  tempMenuColor = { r: rgba[0], g: rgba[1], b: rgba[2], a: tempMenuColor.a };
  updateColorPickerPreview(tempMenuColor);
}

function moveColorCursor(direction) {
  const step = 0.5;
  switch(direction) {
    case 'up':
      colorCursorY = Math.max(0, colorCursorY - step);
      break;
    case 'down':
      colorCursorY = Math.min(59, colorCursorY + step);
      break;
    case 'left':
      colorCursorX = Math.max(0, colorCursorX - step);
      break;
    case 'right':
      colorCursorX = Math.min(119, colorCursorX + step);
      break;
  }
  updateColorPickerCursor();
  updateColorFromCursor();
}

function openPositionPicker(mode) {
  currentState = 'positionpicker';
  positionPickerMode = mode;
  positionPickerModal.style.display = 'flex';
  
  if (mode === 'menu') {
    positionPickerLabel.textContent = 'Hold arrow keys to move the menu';
    tempMenuPosX = currentMenuPosX;
    tempMenuPosY = currentMenuPosY;
  } else if (mode === 'spectator') {
    positionPickerLabel.textContent = 'Hold arrow keys to move the spectator list';
    tempSpectatorPosX = currentSpectatorPosX;
    tempSpectatorPosY = currentSpectatorPosY;
  }
  
  window.luaMenuState = 'positionpicker';
}

function closePositionPicker() {
  currentState = 'menu';
  if (positionPickerMode === 'menu') {
    updateMenuPosition();
  } else if (positionPickerMode === 'spectator') {
    updateSpectatorOverlayPosition();
  }
  
  positionPickerModal.style.display = 'none';
  positionPickerMode = null;
  
  window.luaMenuState = 'menu';
}

function confirmPositionPicker() {
  if (positionPickerMode === 'menu') {
    currentMenuPosX = tempMenuPosX;
    currentMenuPosY = tempMenuPosY;
    updateMenuPosition();
  } else if (positionPickerMode === 'spectator') {
    currentSpectatorPosX = tempSpectatorPosX;
    currentSpectatorPosY = tempSpectatorPosY;
    updateSpectatorOverlayPosition();
  }
  
  closePositionPicker();
}

function movePosition(direction) {
  const step = 0.3;
  
  if (positionPickerMode === 'menu') {
    switch(direction) {
      case 'up':
        tempMenuPosY = Math.max(0, tempMenuPosY - step);
        break;
      case 'down':
        tempMenuPosY = Math.min(100, tempMenuPosY + step);
        break;
      case 'left':
        tempMenuPosX = Math.max(0, tempMenuPosX - step);
        break;
      case 'right':
        tempMenuPosX = Math.min(100, tempMenuPosX + step);
        break;
    }
    
    const offsetX = ((tempMenuPosX - 50) * window.innerWidth * 0.012);
    const offsetY = ((tempMenuPosY - 50) * window.innerHeight * 0.012);
    menuWrapper.style.transform = `translate(${offsetX}px, ${offsetY}px)`;
    
  } else if (positionPickerMode === 'spectator') {
    switch(direction) {
      case 'up':
        tempSpectatorPosY = Math.max(0, tempSpectatorPosY - step);
        break;
      case 'down':
        tempSpectatorPosY = Math.min(100, tempSpectatorPosY + step);
        break;
      case 'left':
        tempSpectatorPosX = Math.max(0, tempSpectatorPosX - step);
        break;
      case 'right':
        tempSpectatorPosX = Math.min(100, tempSpectatorPosX + step);
        break;
    }
    
    const screenX = (tempSpectatorPosX / 100) * window.innerWidth;
    const screenY = (tempSpectatorPosY / 100) * window.innerHeight;
    spectatorOverlay.style.left = `${screenX}px`;
    spectatorOverlay.style.top = `${screenY}px`;
  }
}

function updateSpectatorOverlay() {
  const settings = menuStructure.settings;
  const spectatorEnabled = settings.find(s => s.name === "Spectator List").checked;
  
  if (spectatorEnabled) {
    spectatorListOverlay.innerHTML = '';
    SPECTATORS.forEach((u, idx) => {
      const div = document.createElement('div');
      div.className = 'spectator-overlay-user';
      div.style.fontSize = getDynamicSpectatorFont(u);
      div.textContent = u;
      spectatorListOverlay.appendChild(div);
    });
    updateSpectatorOverlayPosition();
    spectatorOverlay.style.display = 'flex';
  } else {
    spectatorOverlay.style.display = 'none';
  }
}

function updateSpectatorOverlayPosition() {
  const screenX = (currentSpectatorPosX / 100) * window.innerWidth;
  const screenY = (currentSpectatorPosY / 100) * window.innerHeight;
  
  spectatorOverlay.style.left = `${screenX}px`;
  spectatorOverlay.style.top = `${screenY}px`;
  spectatorOverlay.style.right = 'auto';
  spectatorOverlay.style.transform = 'none';
}

function updateMenuPosition() {
  menuOffsetX = ((currentMenuPosX - 50) * window.innerWidth * 0.012);
  menuOffsetY = ((currentMenuPosY - 50) * window.innerHeight * 0.012);
  menuWrapper.style.left = `50%`;
  menuWrapper.style.top = `50%`;
  menuWrapper.style.transform = `translate(${menuOffsetX}px, ${menuOffsetY}px)`;
}

function drawColorPicker() {
  const ctx = colorCanvas.getContext('2d');
  let gradient = ctx.createLinearGradient(0, 0, colorCanvas.width, 0);
  gradient.addColorStop(0, '#ff0000');
  gradient.addColorStop(1 / 6, '#ffff00');
  gradient.addColorStop((1 / 6) * 2, '#00ff00');
  gradient.addColorStop((1 / 6) * 3, '#00ffff');
  gradient.addColorStop((1 / 6) * 4, '#0000ff');
  gradient.addColorStop((1 / 6) * 5, '#ff00ff');
  gradient.addColorStop(1, '#ff0000');
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, colorCanvas.width, colorCanvas.height);
  
  gradient = ctx.createLinearGradient(0, 0, 0, colorCanvas.height);
  gradient.addColorStop(0, 'rgba(255, 255, 255, 1)');
  gradient.addColorStop(0.5, 'rgba(255, 255, 255, 0)');
  gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, colorCanvas.width, colorCanvas.height);
  
  gradient = ctx.createLinearGradient(0, 0, 0, colorCanvas.height);
  gradient.addColorStop(0, 'rgba(0, 0, 0, 0)');
  gradient.addColorStop(0.5, 'rgba(0, 0, 0, 0)');
  gradient.addColorStop(1, 'rgba(0, 0, 0, 1)');
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, colorCanvas.width, colorCanvas.height);
}

function updateColorPickerPreview(rgba) {
  colorPickerPreview.style.background = `rgba(${rgba.r},${rgba.g},${rgba.b},${rgba.a})`;
  colorPickerValues.textContent = `rgba(${rgba.r},${rgba.g},${rgba.b},${Math.round(rgba.a*100)/100})`;
}

function getHueFromRGB(r,g,b) {
  r /= 255; g /= 255; b /= 255;
  let max = Math.max(r, g, b), min = Math.min(r, g, b);
  let h, s, v = max;
  let d = max - min;
  s = max === 0 ? 0 : d / max;
  if(max === min){
      h = 0;
  } else {
      switch(max){
          case r: h = (g - b) / d + (g < b ? 6 : 0); break;
          case g: h = (b - r) / d + 2; break;
          case b: h = (r - g) / d + 4; break;
      }
      h /= 6;
  }
  return Math.round(h * 360) || 0;
}

document.addEventListener('contextmenu', e => e.preventDefault());
document.addEventListener('selectstart', e => e.preventDefault());
document.addEventListener('dragstart', e => e.preventDefault());
document.addEventListener('click', e => e.preventDefault());
document.addEventListener('mousedown', e => e.preventDefault());
document.addEventListener('mouseup', e => e.preventDefault());
document.addEventListener('mousemove', e => e.preventDefault());
document.addEventListener('wheel', e => e.preventDefault());
document.addEventListener('keydown', e => e.preventDefault());
document.addEventListener('keyup', e => e.preventDefault());
document.addEventListener('keypress', e => e.preventDefault());

renderMenu();
updateMenuPosition();
console.log("XYZ Menu loaded - Waiting for Lua input");
</script>
</body>
</html>
